<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a0f0b" />
  <title>Way • Kin • Alex — Chat</title>
  <style>
    :root{--bg:#0a0f0b;--bg2:#0f1a12;--glass:#0f1a13;--text:#f8fff6;--muted:#cde3cf;--border:#203326;--brand:#e53935;--brand2:#36c06b;--accent:#ffd166}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:system-ui,Segoe UI,Prompt,sans-serif;color:var(--text);background:linear-gradient(180deg,var(--bg),var(--bg2))}
    .wrap{max-width:820px;margin:auto;padding:14px}
    .head{display:flex;align-items:center;justify-content:space-between;gap:10px;background:linear-gradient(180deg,#132017,#0e1812);border:1px solid var(--border);border-radius:16px;padding:10px}
    .title{font-weight:900;letter-spacing:.3px}
    .btn{padding:8px 12px;border-radius:12px;border:1px solid var(--border);background:linear-gradient(180deg,#14241a,#0f1b14);color:#f2fff2;font-weight:700;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--brand),var(--brand2));color:#1b0d0d;border:none}
    .pill{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border:1px solid var(--border);border-radius:999px;background:#132319;font-size:12px}
    .grid{display:grid;gap:10px}
    .row2{grid-template-columns:1fr 1fr}
    .card{background:var(--glass);border:1px solid var(--border);border-radius:14px;padding:12px}
    .chat{height:56vh;overflow:auto;display:flex;flex-direction:column;gap:8px;background:#0e1511;border:1px solid var(--border);border-radius:12px;padding:10px}
    .msg{display:flex;gap:8px}
    .me .bubble{background:#152319}
    .bubble{background:#0f1b14;border:1px solid var(--border);padding:8px 10px;border-radius:12px;max-width:85%}
    .meta{color:#bcd6c1;font-size:12px;margin-bottom:2px}
    .input{display:flex;gap:8px}
    textarea{flex:1;min-height:44px;max-height:120px;resize:vertical;background:#0f1a13;color:#fff;border:1px solid var(--border);border-radius:12px;padding:10px}
    .muted{color:var(--muted)}
    .tools{display:flex;gap:8px;flex-wrap:wrap}
    .hide{display:none}
    .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.14),transparent);margin:8px 0}
    @media (max-width:480px){ .row2{grid-template-columns:1fr} }
  </style>
</head>
<body>
<div class="wrap">
  <header class="head">
    <div>
      <div class="title">Way • Kin • Alex — Chat</div>
      <div class="muted" style="font-size:12px">โหมดฟรี (จำลอง) + ใส่ API key เพื่อใช้ AI จริงได้</div>
    </div>
    <div class="tools">
      <button id="btnInstall" class="btn">ติดตั้งแอป</button>
      <button id="btnSettings" class="btn">⚙️</button>
    </div>
  </header>

  <section class="card grid" style="margin-top:10px">
    <div class="tools">
      <label class="pill"><input type="checkbox" id="botWay" checked> Way</label>
      <label class="pill"><input type="checkbox" id="botKin" checked> Kin</label>
      <label class="pill"><input type="checkbox" id="botAlex" checked> Alex</label>
      <span class="pill">โหมด: <b id="modeTxt">จำลอง</b></span>
    </div>
    <div class="chat" id="chat" aria-live="polite"></div>
    <div class="input">
      <textarea id="txt" placeholder="พิมพ์คุยกับ Way/Kin/Alex…"></textarea>
      <button id="send" class="btn primary">ส่ง</button>
    </div>
    <div class="tools">
      <button class="btn" id="btnNew">เริ่มแชทใหม่</button>
      <button class="btn" id="btnExport">สำรองข้อมูล</button>
      <label class="btn"><input id="importFile" type="file" accept="application/json" hidden>นำเข้าข้อมูล</label>
      <button class="btn" id="btnClear">ลบทั้งหมด</button>
    </div>
  </section>

  <!-- Settings Modal -->
  <section id="settings" class="card hide">
    <h3 style="margin:0">ตั้งค่า</h3>
    <div class="hr"></div>
    <div class="grid row2">
      <div>
        <label class="muted">OpenAI API Key (ไม่จำเป็น)<br><small>เก็บใน session — ปิดแท็บแล้วหาย</small></label>
        <input id="apiKey" placeholder="sk-..." style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f1a13;color:#fff">
      </div>
      <div>
        <label class="muted">โมเดล</label>
        <select id="model" style="width:100%;padding:10px;border-radius:10px;border:1px solid var(--border);background:#0f1a13;color:#fff">
          <option value="gpt-4o-mini">gpt-4o-mini</option>
          <option value="o3-mini">o3-mini (reasoning)
          </option>
          <option value="gpt-3.5-turbo">gpt-3.5-turbo (ประหยัด)</option>
        </select>
      </div>
    </div>
    <div class="tools" style="margin-top:8px">
      <button class="btn primary" id="saveSettings">บันทึก</button>
      <button class="btn" id="closeSettings">ปิด</button>
    </div>
  </section>
</div>

<script>
// ================= PWA (single-file) =================
// 1) Create manifest & service worker from Blob soไฟล์เดียวก็ install ได้
const ICON192 = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAAAwCAYAAAC0iQvNAAAACXBIWXMAAAsSAAALEgHS3X78AAABTElEQVR4nO3asU0CURSG4e8YgQmVZPpQ4nDqYF8m8mJY2p8g0oXo7QXG3w6mM2p5q7tR6j8gQmJb+gP9g1ZC4Q0k8W2m1tP9/8VQeKp8cZ5f9I2g2m6w5m4Ww3fB2c2mYJ6G3S7W5B1H9m0q5cDgF2sB6kO9v9yT2bY7wQ1eW5b3t9e2W3t8cB2g1r8hDL0s7mVbZ2rOeR0c3mQy2Ff0mZr4s6b3M0k9hPHt6cBY1u1r9J9yB1k0zSdD4k7h2t6w9m3YVhYF8BvVQw0b3j9sB3mJmJY8t4w0f4fVg7cJg9FvQe1+H1J2P9bqv2+5c1gJb8mQ7G0r8Y8n8v5oU6cKqfQAAAAAElFTkSuQmCC';
const ICON512 = ICON192; // ใช้อันเดียวให้เบาไฟล์

const manifest = {
  name: 'Way • Kin • Alex — Chat',
  short_name: 'WKA Chat',
  start_url: '.',
  display: 'standalone',
  background_color: '#0a0f0b',
  theme_color: '#0a0f0b',
  icons: [
    { src: ICON192, sizes: '192x192', type: 'image/png' },
    { src: ICON512, sizes: '512x512', type: 'image/png' }
  ]
};

(function attachManifest(){
  const blob = new Blob([JSON.stringify(manifest)], {type: 'application/manifest+json'});
  const link = document.createElement('link');
  link.rel = 'manifest';
  link.href = URL.createObjectURL(blob);
  document.head.appendChild(link);
})();

(async function registerSW(){
  if (!('serviceWorker' in navigator)) return;
  // สร้างไฟล์ sw จาก Blob
  const swCode = `self.addEventListener('install',e=>{self.skipWaiting();e.waitUntil(caches.open('wka-v1').then(c=>c.addAll(['./'])))});
self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});
self.addEventListener('fetch',e=>{e.respondWith(fetch(e.request).catch(()=>caches.match('./')))});`;
  const blob = new Blob([swCode], {type:'text/javascript'});
  const swURL = URL.createObjectURL(blob);
  try{ await navigator.serviceWorker.register(swURL,{scope:'./'}); }catch(err){ console.warn('SW failed', err); }
})();

// Install prompt handler
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; document.getElementById('btnInstall').classList.add('primary'); });
document.getElementById('btnInstall').addEventListener('click', async ()=>{
  if(!deferredPrompt){ alert('ถ้าไม่มีปุ่มติดตั้งเด้ง แปลว่าติดตั้งไปแล้วหรือเบราว์เซอร์ยังไม่พร้อม'); return; }
  deferredPrompt.prompt();
  await deferredPrompt.userChoice; deferredPrompt = null; document.getElementById('btnInstall').classList.remove('primary');
});

// ================= Chat core =================
const SKEY = 'wka_chat_threads_v1';
const chatEl = document.getElementById('chat');
const txt = document.getElementById('txt');
const modelSel = document.getElementById('model');
const apiKeyBox = document.getElementById('apiKey');

function loadThreads(){ try{ return JSON.parse(localStorage.getItem(SKEY)||'[]'); }catch{return []} }
function saveThreads(v){ localStorage.setItem(SKEY, JSON.stringify(v)); }

let threads = loadThreads();
if(!threads.length) threads.push({ id: Date.now(), msgs: [] });
let cur = threads[0];

function addMsg(role, who, text){
  cur.msgs.push({ts:Date.now(), role, who, text}); saveThreads(threads);
  const row = document.createElement('div'); row.className = 'msg'+(role==='me'?' me':'');
  row.innerHTML = `<div class="bubble"><div class="meta">${who} • ${new Date().toLocaleTimeString()}</div><div>${escapeHtml(text)}</div></div>`;
  chatEl.appendChild(row); chatEl.scrollTop = chatEl.scrollHeight;
}
function escapeHtml(s){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]))}

// Personas (simulate tone)
const P = {
  way:"เวย์: กวนๆ แต่หวังดี สรุปเร็ว เน้นทำได้จริง",
  kin:"คิน: ขรึม ดุ นิ่ง สั่งเป็นขั้นตอนสั้นๆ",
  alex:"อเล็กซ์: สุภาพ คลีน ช่วยจัดโครง/สองภาษาเมื่อเหมาะสม"
};

// Free-mode generator (no API)
function fakeReply(bot, input){
  const base = {
    way: [
      "เอางี้นะ—", "ฟังพี่แป๊บ—", "สรุปสั้นๆ ให้เลย: "
    ],
    kin: [
      "ขั้นตอน:", "ทำตามนี้.", "ตัดจบ: "
    ],
    alex:[
      "Certainly.", "Here you go:", "สรุปเป็นข้อ ๆ:"
    ]
  }[bot];
  const pick = base[Math.floor(Math.random()*base.length)];
  const tail = input.length>60? input.slice(0,60)+'…' : input;
  if(bot==='alex') return `${pick} ${tail}\n— หากต้องการรายละเอียดต่อ แจ้งจุดที่อยากโฟกัสได้ครับ.`;
  if(bot==='kin') return `${pick} 1) โฟกัสหัวข้อหลัก 2) ตัดของที่ไม่จำเป็น 3) ลงมือทันที.`;
  return `${pick}${tail? ' '+tail: ''} เดี๋ยวกูช่วยไล่ทีละสเต็ปให้เอง.`;
}

function modeIsPro(){ return !!sessionStorage.getItem('WKA_API_KEY'); }
function refreshMode(){ document.getElementById('modeTxt').textContent = modeIsPro()? 'AI จริง (API)': 'จำลอง'; }

async function callOpenAI(messages){
  const key = sessionStorage.getItem('WKA_API_KEY');
  if(!key) throw new Error('NO_KEY');
  const model = modelSel.value;
  const r = await fetch('https://api.openai.com/v1/chat/completions',{
    method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${key}`},
    body: JSON.stringify({ model, messages, temperature:0.7 })
  });
  if(!r.ok){ throw new Error('HTTP '+r.status+' '+await r.text()); }
  const data = await r.json();
  return data.choices?.[0]?.message?.content?.trim()||'';
}

async function replyOne(bot,input){
  if(modeIsPro()){
    const persona = {
      way:`You are Way: playful but caring Thai friend, bikes lover. Keep answers short and actionable.`,
      kin:`You are Kin: terse, stoic, direct. Bullet steps.`,
      alex:`You are Alex: polite, clear, tidy structure, bilingual TH/EN when helpful.`
    }[bot];
    const histories = cur.msgs.slice(-10).map(m=>({role:m.role==='me'?'user':'assistant', content:`[${m.who}] ${m.text}`}));
    const out = await callOpenAI([{role:'system',content:persona}, ...histories, {role:'user', content:input}]);
    return out;
  }
  return fakeReply(bot,input);
}

async function send(){
  const text = txt.value.trim(); if(!text) return; txt.value='';
  addMsg('me','Ryu',text);
  const bots = [];
  if(document.getElementById('botWay').checked) bots.push('way');
  if(document.getElementById('botKin').checked) bots.push('kin');
  if(document.getElementById('botAlex').checked) bots.push('alex');
  if(!bots.length){ addMsg('bot','System','เปิดอย่างน้อย 1 บอทก่อน'); return; }

  for(const b of bots){
    addMsg('bot', b.toUpperCase(), '…กำลังพิมพ์');
    try{
      const out = await replyOne(b, text);
      // แทนที่บับเบิลล่าสุดของบอทนั้น
      const last = [...chatEl.querySelectorAll('.msg')].reverse().find(el=>el.querySelector('.meta')?.textContent?.includes(b.toUpperCase()));
      if(last) last.querySelector('.bubble div:last-child').innerHTML = escapeHtml(out);
      else addMsg('bot', b.toUpperCase(), out);
    }catch(err){
      addMsg('bot','Error', String(err));
    }
  }
}

document.getElementById('send').onclick = send;
txt.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); send(); }});

// Settings
const panel = document.getElementById('settings');
document.getElementById('btnSettings').onclick = ()=>{ panel.classList.remove('hide'); apiKeyBox.value = sessionStorage.getItem('WKA_API_KEY')||''; };
document.getElementById('closeSettings').onclick = ()=> panel.classList.add('hide');
document.getElementById('saveSettings').onclick = ()=>{
  const v = apiKeyBox.value.trim();
  if(v){ sessionStorage.setItem('WKA_API_KEY', v); } else { sessionStorage.removeItem('WKA_API_KEY'); }
  refreshMode(); panel.classList.add('hide');
};

// Threads utilities
function render(){ chatEl.innerHTML=''; cur.msgs.forEach(m=> addMsg(m.role,m.who,m.text)); }
render(); refreshMode();

document.getElementById('btnNew').onclick = ()=>{ threads.unshift({id:Date.now(), msgs:[]}); cur = threads[0]; saveThreads(threads); chatEl.innerHTML=''; };
document.getElementById('btnClear').onclick = ()=>{ if(confirm('ลบประวัติทั้งหมดบนเครื่องนี้?')){ localStorage.removeItem(SKEY); threads=[{id:Date.now(),msgs:[]}]; cur=threads[0]; render(); } };

// Export/Import
function toBlob(data){ return new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); }
document.getElementById('btnExport').onclick = ()=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(toBlob(threads)); a.download='wka-chat-backup.json'; a.click(); };
document.getElementById('importFile').addEventListener('change', async (e)=>{
  const f=e.target.files[0]; if(!f) return; try{ const txt=await f.text(); const obj=JSON.parse(txt); if(Array.isArray(obj)){ threads=obj; cur=threads[0]||{id:Date.now(),msgs:[]}; saveThreads(threads); render(); } }catch(err){ alert('ไฟล์ไม่ถูกต้อง'); }
});
</script>
</body>
</html>

